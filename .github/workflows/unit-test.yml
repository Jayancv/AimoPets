name: Unit Tests (dev)

# Trigger when pushing to dev branch
on:
  push:
    branches:
      - dev

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect changed files
    runs-on: ubuntu-latest
    outputs:
      run_frontend: ${{ steps.set.outputs.run_frontend }}
      run_backend: ${{ steps.set.outputs.run_backend }}
      changed_files: ${{ steps.set.outputs.changed_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed files
        id: set
        run: |
          # git diff between previous and current commit
          BEFORE=${{ github.event.before }}
          AFTER=${{ github.sha }}

          # If BEFORE is all zeros (first push), compare against empty tree
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            changed=$(git ls-tree --name-only -r $AFTER)
          else
            changed=$(git diff --name-only "$BEFORE" "$AFTER")
          fi

          echo "Changed files:"
          echo "$changed"

          frontend=false
          backend=false
          others=false

          # iterate changed file list
          for f in $changed; do
            if [[ "$f" == frontend/* ]]; then
              frontend=true
            elif [[ "$f" == backend/* ]]; then
              backend=true
            else
              others=true
            fi
          done

          # Decide run flags based on rules:
          # - only frontend => run_frontend=true, run_backend=false
          # - only backend => run_frontend=false, run_backend=true
          # - otherwise => run both
          if [[ "$frontend" == "true" && "$backend" == "false" && "$others" == "false" ]]; then
            run_frontend=true
            run_backend=false
          elif [[ "$backend" == "true" && "$frontend" == "false" && "$others" == "false" ]]; then
            run_frontend=false
            run_backend=true
          else
            # both or other changes or no changes -> run both
            run_frontend=true
            run_backend=true
          fi

          # export outputs
          echo "run_frontend=$run_frontend" >> $GITHUB_OUTPUT
          echo "run_backend=$run_backend" >> $GITHUB_OUTPUT
          # also keep a short list of changed files for debugging logs
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  frontend-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.run_frontend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node modules
        uses: actions/cache@v4
        id: node-cache
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json', 'frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      - name: Run frontend unit tests
        working-directory: frontend
        run: npm run test:ci

  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.run_backend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Run backend unit tests (Maven)
        working-directory: backend
        run: |
          mvn -B test -DskipITs

  summarize:
    name: Summary & debug
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - frontend-tests
      - backend-tests
    if: always()
    steps:
      - name: Show decision
        run: |
          echo "run_frontend: ${{ needs.detect-changes.outputs.run_frontend }}"
          echo "run_backend:  ${{ needs.detect-changes.outputs.run_backend }}"
          echo "changed_files:"
          echo "${{ needs.detect-changes.outputs.changed_files }}"
